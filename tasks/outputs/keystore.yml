---

- name: Remove existing keystore record
  command: "{{ beats_flavor }} keystore remove {{ item }}"
  register: result
  failed_when:
    - result is failed
    - result.stderr is not search('could not find key')
  when: beats_keystore_update | bool
  loop:
    - OUTPUT_CERT_KEY_PASSPHRASE
    - OUTPUT_USER
    - OUTPUT_PASS
    - KIBANA_USER
    - KIBANA_PASS
    - KIBANA_CERT_KEY_PASSPHRASE

- name: List keystore settings
  command: "{{ beats_flavor }} keystore list"
  register: _beats_keystore_settings
  changed_when: false

- name: Add passwords and passphrases to beats keystore
  shell: |
    set -o pipefail;
    echo {{ lookup('vars', item.1) }} |
      {{ beats_flavor }} keystore add \
      {{ item.0 }} --stdin
  args:
    executable: /bin/bash
  when:
    - _beats_keystore_settings.stdout is not search(item.0)
    - lookup('vars', item.1) != None
  loop: "{{ keystore_keys | zip(beats_vars) | list }}"
  vars:
    keystore_keys:
      - OUTPUT_CERT_KEY_PASSPHRASE
      - OUTPUT_USER
      - OUTPUT_PASS
      - KIBANA_USER
      - KIBANA_PASS
      - KIBANA_CERT_KEY_PASSPHRASE
    beats_vars:
      - beats_certificates_password
      - beats_output_user
      - beats_output_pass
      - beats_kibana_username
      - beats_kibana_password
      - beats_kibana_ssl_key_passphrase
  notify: beats restart service
  no_log: true
