---

- name: Remove existing keystore record
  command: auditbeat keystore remove "{{ item }}"
  register: result
  failed_when:
    - result is failed
    - result.stderr is not search('could not find key')
  when: auditbeat_keystore_update | bool
  loop:
    - OUTPUT_CERT_KEY_PASSPHRASE
    - OUTPUT_USER
    - OUTPUT_PASS
    - KIBANA_USER
    - KIBANA_PASS
    - KIBANA_CERT_KEY_PASSPHRASE

- name: List keystore settings
  command: auditbeat keystore list
  register: _auditbeat_keystore_settings
  changed_when: false

- name: Add passwords and passphrases to auditbeat keystore
  shell: |
    set -o pipefail;
    echo {{ lookup('vars', item.1) }} |
      auditbeat keystore add \
      {{ item.0 }} --stdin
  args:
    executable: /bin/bash
  when:
    - _auditbeat_keystore_settings.stdout is not search(item.0)
    - lookup('vars', item.1) != None
  loop: "{{ keystore_keys | zip(auditbeat_vars) | list }}"
  vars:
    keystore_keys:
      - OUTPUT_CERT_KEY_PASSPHRASE
      - OUTPUT_USER
      - OUTPUT_PASS
      - KIBANA_USER
      - KIBANA_PASS
      - KIBANA_CERT_KEY_PASSPHRASE
    auditbeat_vars:
      - auditbeat_certificates_password
      - auditbeat_output_user
      - auditbeat_output_pass
      - auditbeat_kibana_username
      - auditbeat_kibana_password
      - auditbeat_kibana_ssl_key_passphrase
  notify: auditbeat restart service
  no_log: true
