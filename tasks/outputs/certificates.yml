---

- name: "{{ beats_flavor }} certificates tasks for Linux"
  block:
    - name: Create certificates folder on Linux
      file:
        path: "{{ beats_certificates_dir }}"
        state: directory
        owner: root
        group: root
        mode: 0o755

    - name: Upload certificates on Linux
      copy:
        src: "{{ item.value }}"
        dest: "{{ beats_certificates_dir }}/{{ item.value | basename }}"
        owner: root
        mode: "{{ '0o400' if item.key == 'key' else '0o644' }}"
      loop: "{{ beats_certificates| dict2items }}"
      notify: beats restart service
  when: ansible_os_family != 'Windows'

- name: "{{ beats_flavor }} certificates tasks for Windows"
  block:
    - name: Create certificates folder on Windows
      win_file:
        path: "{{ beats_certificates_dir }}"
        state: directory

    - name: Upload certificates on Windows
      win_copy:
        src: "{{ item.value }}"
        dest: "{{ beats_certificates_dir }}/{{ item.value | basename }}"
      loop: "{{ beats_certificates| dict2items }}"
      notify: beats restart service
  when: ansible_os_family == 'Windows'

- name: Add certificates configuration
  set_fact:
    beats_combined_config: >-
      {{
        _beats_output_ssl_config
        | combine(beats_combined_config, recursive=true)
      }}
  vars:
    _beats_ssl_config:
      ssl:
        enabled: true
        verification_mode: full
        certificate_authorities: "{{ beats_certificates_dir }}/{{
                                    beats_certificates['ca'] | basename }}"
        certificate: "{{ beats_certificates_dir }}/{{
                                    beats_certificates['crt'] | basename }}"
        key: "{{ beats_certificates_dir }}/{{
                                    beats_certificates['key'] | basename }}"
        key_passphrase: '${OUTPUT_CERT_KEY_PASSPHRASE}'
    _beats_output_ssl_config: >-
      {%- set outputs = (beats_combined_config['output'].keys() | list) -%}
      {
        {# only one output should be present #}
        {%- for output in outputs -%}
          'output': {
            '{{ output }}': {{ _beats_ssl_config }}
          }
        {%- endfor -%}
      }
